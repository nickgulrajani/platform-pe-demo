name: CI/CD to kind-pe-demo (local + GitHub)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  IMAGE_NAME: hello-api
  IMAGE_TAG: latest
  FULL_IMAGE: hello-api:latest
  KIND_CLUSTER: pe-demo
  KUBE_CONTEXT: kind-pe-demo

jobs:
  # ============================================
  # JOB 1: Build, Test, Scan (runs automatically)
  # ============================================
  build-test-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python deps + tooling
        run: |
          pip install -r app/requirements.txt
          pip install bandit pytest coverage

      - name: SAST Security Scan (Bandit)
        run: bandit -r app

      - name: Run tests with coverage (fail under 80%)
        run: |
          coverage run -m pytest
          coverage report -m --fail-under=80

      - name: IaC Security Scan (Checkov)
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: infra

      - name: Basic syntax check
        run: python -m py_compile app/app.py

      - name: Build Docker image
        run: docker build -t ${{ env.FULL_IMAGE }} app

      # Save the image as an artifact for the deploy job
      - name: Save Docker image
        run: docker save ${{ env.FULL_IMAGE }} -o image.tar

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: image.tar
          retention-days: 1

  # ============================================
  # JOB 2: Deploy (PAUSES for approval)
  # ============================================
  deploy:
    runs-on: ubuntu-latest
    needs: build-test-scan
    environment: production        # ← Approval gate here

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Load Docker image
        run: docker load -i image.tar

      - name: Install kind, kubectl, terraform
        run: |
          sudo apt-get update
          sudo apt-get install -y curl ca-certificates gnupg lsb-release unzip

          # kubectl
          curl -LO "https://dl.k8s.io/release/$(curl -Ls https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl

          # kind
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.23.0/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind

          # terraform
          TF_VERSION="1.9.5"
          curl -LO https://releases.hashicorp.com/terraform/${TF_VERSION}/terraform_${TF_VERSION}_linux_amd64.zip
          unzip terraform_${TF_VERSION}_linux_amd64.zip
          sudo mv terraform /usr/local/bin/

      - name: Create or ensure kind cluster
        run: |
          if ! kind get clusters | grep -q "^${{ env.KIND_CLUSTER }}$"; then
            kind create cluster --name "${{ env.KIND_CLUSTER }}"
          fi

      - name: Load image into kind cluster
        run: kind load docker-image ${{ env.FULL_IMAGE }} --name "${{ env.KIND_CLUSTER }}"

      - name: Configure kube context
        run: |
          kubectl config use-context ${{ env.KUBE_CONTEXT }}
          kubectl get nodes

      - name: Terraform sanity checks
        working-directory: infra
        run: |
          terraform fmt -recursive
          terraform init -backend=false
          terraform validate
          terraform plan -input=false -lock=false

      - name: Terraform apply
        working-directory: infra
        run: terraform apply -auto-approve -var "image=${{ env.FULL_IMAGE }}"

      - name: Kubernetes sanity checks
        run: |
          kubectl -n platform-demo get deploy hello-api
          kubectl -n platform-demo get pods
          kubectl -n platform-demo get svc hello-api
          kubectl -n platform-demo wait deploy/hello-api --for=condition=available --timeout=60s
          echo "✅ Deployment complete and verified"
```
